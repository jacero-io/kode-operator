version: '3'

vars:
  SYSBOX_INSTALL_MANIFEST: https://raw.githubusercontent.com/nestybox/sysbox/master/sysbox-k8s-manifests/sysbox-install.yaml

tasks:
  apply-sysbox:
    desc: Apply Sysbox installation manifest
    internal: true
    cmds:
      - kubectl apply -f https://raw.githubusercontent.com/nestybox/sysbox/master/sysbox-k8s-manifests/sysbox-install.yaml

  wait-for-sysbox:
    desc: Wait for Sysbox installation to complete
    internal: true
    cmds:
      - |
        echo "Waiting for Sysbox installation to complete..."
        kubectl wait --for=condition=ready pod -l app=sysbox-deploy-k8s -n kube-system --timeout=300s

  install:
    desc: Install Sysbox on the Kind cluster
    cmds:
      - task: apply-sysbox
      # - task: wait-for-sysbox
      - echo "Sysbox installation completed. The Kubelet may restart on the nodes where Sysbox was installed."

  uninstall:
    desc: Uninstall Sysbox from the Kind cluster
    cmds:
      - kubectl delete -f https://raw.githubusercontent.com/nestybox/sysbox/master/sysbox-k8s-manifests/sysbox-install.yaml
      - sleep 30
      - kubectl apply -f https://raw.githubusercontent.com/nestybox/sysbox/master/sysbox-k8s-manifests/sysbox-uninstall.yaml
      - sleep 60
      - kubectl delete -f https://raw.githubusercontent.com/nestybox/sysbox/master/sysbox-k8s-manifests/sysbox-uninstall.yaml
      - echo "Sysbox uninstallation completed. Make sure to stop all Sysbox pods before uninstalling."
